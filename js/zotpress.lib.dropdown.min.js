jQuery(document).ready((function(){if(jQuery(".zp-Browse").length>0)for(let r=0;r<window.zpBrowseList.length;++r){var e=jQuery("#"+window.zpBrowseList[r].id),t={zpCollectionId:!1,zpTagId:!1,zpShowTags:!1,zpShowImages:!1,zpIsAdmin:!1,zpTarget:!1,zpTopLevel:!1,zpURLWrap:!1,zpItemsFlag:!0};jQuery(".ZP_COLLECTION_ID",e).length>0&&(t.zpCollectionId=jQuery(".ZP_COLLECTION_ID",e).text()),jQuery(".ZP_TAG_ID",e).length>0&&(t.zpTagId=jQuery(".ZP_TAG_ID",e).text()),jQuery(".ZP_SHOWTAGS").length>0&&"1"==parseInt(jQuery(".ZP_SHOWTAGS").text())&&(t.zpShowTags=!0),jQuery(".ZP_SHOWIMAGE",e).length>0&&("yes"==jQuery(".ZP_SHOWIMAGE",e).text()||"true"==jQuery(".ZP_SHOWIMAGE",e).text()||"1"==jQuery(".ZP_SHOWIMAGE",e).text())&&(t.zpShowImages=!0),jQuery(".ZP_ISADMIN",e).length>0&&(t.zpIsAdmin=!0),jQuery(".ZP_TARGET",e).length>0&&jQuery(".ZP_TARGET").text().length>0&&(t.zpTarget=!0),jQuery(".ZP_TOPLEVEL",e).length>0&&(t.zpTopLevel=jQuery(".ZP_TOPLEVEL",e).text(),!1===t.zpCollectionId&&!1===t.zpTagId&&(t.zpCollectionId=t.zpTopLevel)),jQuery(".ZP_URLWRAP",e).length>0&&(t.zpURLWrap=jQuery(".ZP_URLWRAP",e).text());var a=!1;jQuery(".ZP_UPDATENEEDED",e).text().trim().length>0&&"true"==jQuery(".ZP_UPDATENEEDED",e).text()&&(a=!0);var s=!0;""==jQuery(".ZP_BROWSEBAR",e).text()&&(s=!1),s&&(o(r,t,e,0,0,!1),l(r,t,e,0,0,!1)),n(r,t,e,0,0,!1),console.log("---")}function r(e){if(0!=jQuery("div.zp-List .csl-left-margin",e).length&&/\d/.test(jQuery("div.zp-List .csl-left-margin",e).text())){var t=1;jQuery("div.zp-List .csl-left-margin",e).each((function(){jQuery(this).text(jQuery(this).text().replace(/(\d+)/,t)),t++}))}}function o(e,t,a,s,r,l){void 0!==s&&"false"!=s&&""!=s||(s=0),void 0!==r&&"false"!=r&&""!=r||(r=0),jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",api_user_id:jQuery(".ZP_API_USER_ID",a).text(),item_type:"collections",collection_id:t.zpCollectionId,request_start:s,request_last:r,sortby:"title",get_top:!0,update:l,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(s){var r=jQuery.parseJSON(s),n="";!1===l&&jQuery("select.zp-Browse-Collections-Select",a).addClass("used_cache"),!0!==l||jQuery("select.zp-Browse-Collections-Select",a).hasClass("updating")||(jQuery("select.zp-Browse-Collections-Select",a).find("*").not(".blank").remove(),jQuery("select.zp-Browse-Collections-Select",a).addClass("updating"),t.zpTagId&&jQuery("select.zp-Browse-Collections-Select",a).append("<option value='blank'>--"+zpShortcodeAJAX.txt_nocollsel+"--</option>")),t.zpCollectionId&&0==jQuery(".zp-Browse-Collections-Select option.blank",a).length&&jQuery(".ZP_COLLECTION_NAME",a).length>0&&jQuery("select.zp-Browse-Collections-Select",a).append("<option value='blank' class='blank'>"+jQuery(".ZP_COLLECTION_NAME",a).text()+"</option>\n"),"0"!=r&&r.data.length>0&&"0"!=r.data&&(jQuery.each(r.data,(function(e,a){var s="<option value='"+a.key+"'";t.zpCollectionId==a.key&&(s+=" selected='selected'"),s+=">",t.zpCollectionId&&(s+="- "),s+=a.data.name+" (",a.meta.numCollections>0&&(s+=a.meta.numCollections+" "+zpShortcodeAJAX.txt_subcoll+", "),s+=a.meta.numItems+" "+zpShortcodeAJAX.txt_items+")</option>\n",n+=s})),jQuery("select.zp-Browse-Collections-Select",a).append(n),0!=r.meta.request_next&&"false"!=r.meta.request_next?o(e,t,a,r.meta.request_next,r.meta.request_last,l):jQuery("select.zp-Browse-Collections-Select",a).hasClass("updating")||o(e,t,a,0,0,!0)),t.zpCollectionId&&"toplevel"!=t.zpCollectionId&&0==jQuery(".zp-Browse-Collections-Select option.toplevel",a).length&&jQuery("select.zp-Browse-Collections-Select",a).append("<option value='toplevel' class='toplevel'>&larr; "+zpShortcodeAJAX.txt_backtotop+"</option>\n"),jQuery("select.zp-Browse-Collections-Select",a).removeClass("loading").find(".loading").remove()},error:function(e){console.log("Error for zplib_get_collections(): ",e.statusText)},complete:function(e,t){}})}function l(e,t,a,s,r,o){void 0!==s&&"false"!=s&&""!=s||(s=0),void 0!==r&&"false"!=r&&""!=r||(r=0),jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",api_user_id:jQuery(".ZP_API_USER_ID",a).text(),item_type:"tags",is_dropdown:!0,maxtags:jQuery(".ZP_MAXTAGS",a).text(),request_start:s,request_last:r,update:o,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(s){var r=jQuery.parseJSON(s),n="<option class='zp-List-Tags-Select' name='zp-List-Tags-Select'>--"+zpShortcodeAJAX.txt_notagsel+"--</option>\n";t.zpTagId&&(n="<option value='toplevel' class='toplevel'>--"+zpShortcodeAJAX.txt_unsettag+"--</option>\n"),!1===o&&jQuery("select.zp-List-Tags",a).addClass("used_cache"),!0!==o||jQuery("select.zp-List-Tags",a).hasClass("updating")||jQuery("select.zp-List-Tags",a).empty().addClass("updating"),0!==r&&r.data.length>0?(jQuery.each(r.data,(function(e,t){var s="<option class='zp-List-Tag' value='"+t.tag.replace(/ /g,"+")+"'";jQuery(".ZP_TAG_ID",a).length>0&&jQuery(".ZP_TAG_ID",a).text()==t.tag&&(s+=" selected='selected'"),s+=">"+t.tag+" ("+t.meta.numItems+" "+zpShortcodeAJAX.txt_items+")</option>\n",n+=s})),jQuery("select.zp-List-Tags",a).append(n),0!=r.meta.request_next&&"false"!=r.meta.request_next?l(e,t,a,r.meta.request_next,r.meta.request_last,o):jQuery("select.zp-List-Tags",a).hasClass("updating")||l(e,t,a,0,0,!0),jQuery("select.zp-List-Tags",a).removeClass("loading").find(".loading").remove()):(jQuery("select.zp-List-Tags",a).removeClass("loading").find(".loading").remove(),jQuery("select.zp-List-Tags",a).append("<option rel='empty' value='empty'>"+zpShortcodeAJAX.txt_notags+"</option>"))},error:function(e){console.log("Error for zplib_get_tags(): ",e.statusText)},complete:function(e,t){}})}function n(e,t,s,o,l,i){console.log("zp: calling zplib_get_items with update check?",i),console.log("zp: is an update needed?",a),void 0!==o&&"false"!=o&&""!=o||(o=0),void 0!==l&&"false"!=l&&""!=l||(l=0),jQuery(".zp-List",s).hasClass("loading")&&""==jQuery(".zp-List",s).find(".zp_display_progress").text()&&jQuery(".zp-List",s).append("<div class='zp_display_progress'>"+zpShortcodeAJAX.txt_loading+" ...</div>"),jQuery.ajax({async:!0,url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",api_user_id:jQuery(".ZP_API_USER_ID",s).text(),is_dropdown:!0,item_type:"items",citeable:jQuery(".ZP_CITEABLE",s).text(),downloadable:jQuery(".ZP_DOWNLOADABLE",s).text(),showtags:t.zpShowTags,showimage:t.zpShowImages,target:t.zpTarget,urlwrap:t.zpURLWrap,collection_id:t.zpCollectionId,tag_id:t.zpTagId,get_top:!0,sortby:jQuery(".ZP_SORTBY",s).text(),order:jQuery(".ZP_ORDER",s).text(),update:i,request_update:a,request_start:o,request_last:l,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(l){var p=jQuery.parseJSON(l);if(!1===i?jQuery(".zp-List",s).addClass("used_cache"):!0===i&&(jQuery(".zp-List",s).hasClass("updating")||jQuery(".zp-List",s).addClass("updating")),void 0!==p&&null!=p&&0!=p&&p.data.length>0&&0!=p.data){var u="";if(jQuery(".zp-List",s).hasClass("updating")||!1===p.meta.request_last||"false"==p.meta.request_last||0===p.meta.request_last||jQuery(".zp-List",s).find(".zp_display_progress").html("Loading "+p.meta.request_next+"-"+(p.meta.request_next+50)+" out of "+(parseInt(p.meta.request_last)+50)+"..."),0!=p.data&&jQuery.each(p.data,(function(e,a){var r="",o=jQuery("div.zp-List .zp-ID-"+a.library.id+"-"+a.key,s),l="0000";a.meta.hasOwnProperty("parsedDate")&&(l=a.meta.parsedDate.substring(0,4));var n=a.data.title;a.meta.hasOwnProperty("creatorSummary")&&(n=a.meta.creatorSummary.replace(/ /g,"-")),r+="<div id='zp-ID-"+a.library.id+"-"+a.key+"' class='zp-Entry zpSearchResultsItem hidden",!0===i&&(r+=" zp_updated"),r+="' data-zp-author-year='"+n+"-"+l+"'",r+="' data-zp-year-author='"+l+"-"+n+"'",r+=">\n",(t.zpIsAdmin||t.zpShowImages&&a.hasOwnProperty("image"))&&(r+="<div id='zp-Citation-"+a.key+"' class='zp-Entry-Image",a.hasOwnProperty("image")&&(r+=" hasImage"),r+="' rel='"+a.key+"'>\n",a.hasOwnProperty("image")&&(r+="<img class='thumb' src='"+a.image[0]+"' alt='image' />\n"),t.zpIsAdmin&&(a.hasOwnProperty("image")?r+="<a title='Change Image' class='upload' rel='"+a.key+"' href='#'>"+zpShortcodeAJAX.txt_changeimg+"</a>\n":r+="<a title='Set Image' class='upload' rel='"+a.key+"' href='#'>"+zpShortcodeAJAX.txt_setimg+"</a>\n"),t.zpIsAdmin&&a.hasOwnProperty("image")&&(r+="<a title='"+zpShortcodeAJAX.txt_removeimg+"' class='delete' rel='"+a.key+"' href='#'>&times;</a>\n"),r+="</div>\x3c!-- .zp-Entry-Image --\x3e\n"),r+=a.bib,t.zpShowTags&&a.data.tags.length>0&&(r+="<span class='item_key'>Tag(s): ",jQuery.each(a.data.tags,(function(e,t){0!=e&&(r+=", "),r+=t.tag}))),t.zpIsAdmin&&(r+="<label for='item_key'>"+zpShortcodeAJAX.txt_itemkey+":</label><input type='text' name='item_key' class='item_key' value='"+a.key+"'>\n"),r+="</div>\x3c!-- .zp-Entry --\x3e\n",o.length>0&&!0===i?o.replaceWith(jQuery(r)):u+=r})),!1===i&&jQuery(".zpSearchResultsContainer",s).append(u),0!=p.meta.request_next&&"false"!=p.meta.request_next)1==t.zpItemsFlag?window.zpBrowseList[e].paginate(t.zpItemsFlag,!1):window.zpBrowseList[e].paginate(t.zpItemsFlag,!0),t.zpItemsFlag=!1,0==o&&p.meta.request_last>0&&0==jQuery(".zpSearchResultsPagingScroller",s).length&&(jQuery(".zpSearchResultsPagingContainerInner",s).append('<div class="zpSearchResultsPagingScroller"><span class="zpSearchResultsPagingBack">&#8249;</span><span class="zpSearchResultsPagingForward">&#8250;</span></div>'),jQuery(".zpSearchResultsPagingContainer",s).on("click",".zpSearchResultsPagingBack",(function(){var e=parseInt(jQuery(".zpSearchResultsPaging",s).css("left")),t=parseInt(jQuery(".zpSearchResultsPaging a.selected",s).css("width"))+2*parseInt(jQuery(".zpSearchResultsPaging a.selected",s).css("border-left-width"));0!=e&&jQuery(".zpSearchResultsPaging",s).css("left",e+t+"px")})),jQuery(".zpSearchResultsPagingContainer",s).on("click",".zpSearchResultsPagingForward",(function(){var e=parseInt(jQuery(".zpSearchResultsPaging",s).css("left")),t=parseInt(jQuery(".zpSearchResultsPaging a.selected",s).css("width"))+2*parseInt(jQuery(".zpSearchResultsPaging a.selected",s).css("border-left-width"));-1*e<jQuery(".zpSearchResultsPaging",s).width()-50&&jQuery(".zpSearchResultsPaging",s).css("left",e-t+"px")}))),r(s),n(e,t,s,p.meta.request_next,p.meta.request_last,i);else if(window.zpBrowseList[e].paginate(t.zpItemsFlag),t.zpItemsFlag=!1,jQuery(".zp-List",s).removeClass("loading"),jQuery(".zp-List",s).find(".zp_display_progress").remove(),p.updateneeded)console.log("zp: update needed"),a=!0,n(e,t,s,0,0,!0);else{a=!1;var c=jQuery(".ZP_SORTBY",s).text(),d=jQuery(".ZP_ORDER",s).text();if(-1!==["author","date"].indexOf(c)&&0==jQuery("div.zp-List .csl-left-margin",s).length){var g="data-zp-author-year";"date"==c&&(g="data-zp-year-author"),jQuery("#"+p.instance+" .zp-List div.zp-Entry",s).sort((function(e,t){var a=e.getAttribute(g).toLowerCase(),s=t.getAttribute(g).toLowerCase();return a>s?"asc"==d?1:-1:a<s?"asc"==d?-1:1:0})).detach().appendTo("#"+p.instance+" .zp-List",s)}r(s)}}else jQuery(".zp-List",s).removeClass("loading"),jQuery(".zp-List",s).find(".zp_display_progress").remove(),jQuery(".zpSearchResultsContainer",s).append("<p>"+zpShortcodeAJAX.txt_nocitations+"</p>\n")},error:function(e){console.log("Error for zplib_get_items(): ",e.statusText)}})}}));